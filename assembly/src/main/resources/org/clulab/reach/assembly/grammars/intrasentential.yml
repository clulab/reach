# rather than duplicate it here, the assembly branch was grafted there
taxonomy: org/clulab/reach/biogrammar/taxonomy.yml

# vars for assembly sieve
vars:
  mylabel: "Precedence"
  mypriority: "2"
  myaction: "validatePrecedenceRelations"
  # TODO: fix comparison of binding args to ComplexEvent controlleds
  crosssentenceaction: "identityAction"
  regverbaltrigger: [lemma=/^(promote)/]
  # vars for old rules
  after_type: "Event"
  before_type: "Event"
  deprulepriority: "1"
  surfacerulepriority: "2"
  beforesurface: "[lemma=/^(before|prior|precede)$/]"
  aftersurface: "[lemma=/^follow|after$/]"

# rules for assembly sieve

  ########################
  #
  # intra-sentence cases
  #
  ########################

rules:
  # precedence markers
  - import: org/clulab/reach/assembly/grammars/precedence-markers.yml

  - name: intrasentence-resulting-in
    label: Precedence
    priority: ${mypriority}
    type: token
    action: ${myaction}
    example: "Furthermore , AKT phosphorylates and activates pro-survival protein XIAP ( X linked inhibitor of apoptosis protein ) , resulting in an increase of binding of XIAP to caspases 3 , 7 and 9 and inhibition of these caspases , the activities of which are essential for apoptosis induction ."
    pattern: |
      @before:Event "," resulting in []*? @after:Event

 # FIXME: find the example
  - name: intrasentence-as-a-result-of
    label: Precedence
    priority: ${mypriority}
    type: token
    action: ${myaction}
    example: ""
    pattern: |
      @after:Event as a result of @before:Event
      |
      [lemma=as] a result of @before:Event ","? @after:Event

  - name: intrasentence-leading-to
    label: Precedence
    priority: ${mypriority}
    type: token
    action: ${myaction}
    example: "AMPK directly phosphorylates Raptor in an LKB1 dependent manner leading to the binding of 14-3-3 proteins to Raptor and subsequent inhibition of mTORC1 ."
    pattern: |
      @before:ComplexEvent []*? leading to [tag=DT]? "subsequent"? @after:Event

  - name: intrasentence-where-it
    label: Precedence
    priority: ${mypriority}
    type: token
    action: ${myaction}
    example: "Specifically , FOXO1 phosphorylated by AKT translocates to the cytosol where it is ubiquitinated by Skp2 and subjected to proteasome dependent degradation ( Huang et al. ,     ) ."
    pattern: |
      @before:Event []*? where @after:Event

  - name: intrasentence-semicolon
    label: Precedence
    priority: ${mypriority}
    type: token
    action: ${myaction}
    example: "GTP loaded RAS then triggers the sequential activation of RAF , MEK , and MAPK ; active RAF phosphorylates and activates MEK , which in turn phosphorylates and activates MAPK    ."
    pattern: |
      @before:Event ";" []{,2} @after:Event

  - name: intrasentence-when-it
    label: Precedence
    priority: ${mypriority}
    type: token
    action: ${myaction}
    example: "When eIF4E is bound to 4E-BP1 it is prevented from joining the translation initiation complex but upon phosphorylation by mTOR , 4E-BP1 releases eIF4E which is then phosphorylated by p70S6K and can join the active initiation complex   ."
    pattern: |
      [lemma=when] @before:Event ","? it []*? @after:Event

  # TODO: write action to expand tok to event
  - name: intrasentence-which-in-turn
    label: Precedence
    priority: ${mypriority}
    type: token
    action: expandArgs
    example: "When eIF4E is bound to 4E-BP1 it is prevented from joining the translation initiation complex but upon phosphorylation by mTOR , 4E-BP1 releases eIF4E which is then phosphorylated by p70S6K and can join the active initiation complex   ."
    example2: "The p53 pathway is generally activated by DNA damage , which results in phosphorylation of p53 by ATM or CHK2 at sites near MDM2 and MDM4 binding ."
    pattern: |
      @before:Event []*?
      (?<! each of) ","? which "then"? (in turn)?
      (?<after> [mention=Event.trigger]) # this token should be expanded to an Event


  # (Old rules) Event rules
  - name: assembly-prep-syntax-1
    label: ${mylabel}
    priority: ${deprulepriority}
    example: "BEF is ubiquitinated before the phosphorylation of AFT."
    pattern: |
      before:${before_type}
      # before the AFT
      # TODO: Write surface rule for prior_to relations
      after:${after_type} = prep_before

  - name: assembly-prep-surface-1
    label: ${mylabel}
    priority: ${deprulepriority}
    example: "BEF is ubiquitinated before the phosphorylation of AFT."
    type: token
    pattern: |
      (?<before> ${before_type}) (before | prior to) [tag=/^(DT|CD|JJ)$/]* (?<after> ${after_type})

  - name: assembly-prep-syntax-2
    label: ${mylabel}
    priority: ${deprulepriority}
    example: "AFT is ubiquitinated following the phosphorylation of BEF."
    pattern: |
      after:${after_type}
      # after BEF
      before:${before_type} = /^prep_(after|following)$/

  - name: assembly-prep-surface-2
    label: ${mylabel}
    priority: ${surfacerulepriority}
    example: "AFT is ubiquitinated following the phosphorylation of BEF."
    type: token
    pattern: |
      (?<after> ${after_type}) (after | [lemma=follow]) [tag=/^(DT|CD|JJ)$/]* (?<before> ${before_type})

  - name: assembly-prep-syntax-3
    label: DirectConnection
    priority: ${deprulepriority}
    example: "AFT is ubiquitinated due to the phosphorylation of BEF."
    pattern: |
      after:${after_type}
      # due to BEF
      before:${before_type} = prep_due_to | prep_because_of

  - name: assembly-prep-surface-3
    label: ${mylabel}
    priority: ${surfacerulepriority}
    example: "AFT is ubiquitinated due to the phosphorylation of BEF."
    type: token
    pattern: |
      (?<after> ${after_type}) (due to | because of) [tag=/^(DT|CD|JJ)$/]* (?<before> ${before_type})

#  - name: assembly-verb-syntax-1
#    label: DirectConnection
#    priority: ${deprulepriority}
#    example: "the ubiquitination of BEF leads to the phosphorylation of AFT."
#    pattern: |
#      before:${before_type}
#      # ... leads to AFT
#      after:${after_type} = <nsubj [lemma=/^(lead)$/] prep_to

  - name: assembly-verb-syntax-2a
    label: DirectConnection
    priority: ${deprulepriority}
    example: "the ubiquitination of AFT follows the phosphorylation of BEF."
    pattern: |
      before:${after_type}
      # AFT follows ...
      after:${before_type} =  <dobj [lemma=follow] nsubj

  - name: assembly-verb-syntax-2b
    label: DirectConnection
    priority: ${deprulepriority}
    example: "The ubiquitination of BEF precedes the phosphorylation of AFT. The ubiquitination of BEF precipitates the phosphorylation of AFT."
    pattern: |
      after:${after_type}
      # BEF precedes ...
      before:${before_type} =  <dobj [lemma=/^(precede|precipitat)/] nsubj

  - name: assembly-verb-surface-2b
    label: ${mylabel}
    priority: ${surfacerulepriority}
    example: "The ubiquitination of BEF precedes the phosphorylation of AFT. The ubiquitination of BEF precipitates the phosphorylation of AFT."
    type: token
    pattern: |
      (?<before> ${before_type}) [lemma=/^(precede|precipitat)/] [tag=/^(DT|CD|JJ)$/]* (?<after> ${after_type})

  - name: assembly-verb-syntax-3
    example: "AFT ubiquitination is a result of BEF phosphorylation.  AFT ubiquitination results from BEF phosphorylation."
    label: ${mylabel}
    priority: ${deprulepriority}
    pattern: |
     before:${after_type}
     # AFT results from BEF
     after:${before_type} = </(prepc?_of|prep_from)/ [lemma=result] nsubj

  - name: assembly-verb-surface-3a
    label: ${mylabel}
    priority: ${surfacerulepriority}
    example: "AFT ubiquitination is a result of BEF phosphorylation."
    type: token
    pattern: |
      (?<after> ${after_type}) [lemma=be] [tag=/^(DT|CD|JJ)$/] [lemma=result] of [tag=/^(DT|CD|JJ)$/]* (?<before> ${before_type})

  - name: assembly-verb-surface-3b
    label: ${mylabel}
    priority: ${surfacerulepriority}
    example: "AFT ubiquitination results from BEF phosphorylation."
    type: token
    pattern: |
      (?<after> ${after_type}) ","? [tag=RB]? [lemma=result & tag=/^VB/] from [tag=/^(DT|CD|JJ)$/]* (?<before> ${before_type})

  - name: assembly-verb-syntax-4
    example: "BEF is ubiquitinated, resulting in the phosphorylation of AFT."
    label: ${mylabel}
    priority: ${deprulepriority}
    pattern: |
     after:${after_type}
     # BEF ..., resulting from ...
     before:${before_type} = <prep_in [lemma=result & tag=VBG] >xcomp nsubjpass

  - name: assembly-verb-surface-4and6
    label: ${mylabel}
    priority: ${surfacerulepriority}
    example: "BEF is ubiquitinated, resulting in the phosphorylation of AFT."
    type: token
    pattern: |
      (?<before> ${before_type}) ","? [tag=RB]? [lemma=result & tag=/^VB/] in [tag=/^(DT|CD|JJ)$/]* (?<after> ${after_type})

  - name: assembly-verb-syntax-5
    example: "As a result of BEF phosphorylation, AFT is ubiquitinated. AFT is phosphorylated as a result of BEF ubiqutination."
    label: ${mylabel}
    priority: ${deprulepriority}
    pattern: |
     after:${after_type}
     before:${before_type} = prep_as [lemma=result] /prepc?_of/

  - name: assembly-verb-syntax-6
    example: "AFT phosphorylation results in BEF ubiqutination."
    label: ${mylabel}
    priority: ${deprulepriority}
    pattern: |
     before:${before_type}
     after:${after_type} = <nsubj [lemma=result] prep_in

  - name: assembly-verb-syntax-7
    example: "The RBD of PI3KC2B binds HRAS , when HRAS is not bound to GTP . AFT binds HRAS, when BEF in not bound to GTP"
    label: ${mylabel}
    priority: ${deprulepriority}
    pattern: |
     after:${after_type}
     # ..., when BEF
     # use lookaround assertion to check if WH word present
     before:${before_type} = dobj rcmod (?= advmod [tag=WRB])

  - name: assembly-verb-surface-7
    label: ${mylabel}
    priority: ${surfacerulepriority}
    example: "The RBD of PI3KC2B binds HRAS , when HRAS is not bound to GTP . AFT binds HRAS, when BEF in not bound to GTP"
    type: token
    pattern: |
      (?<before> ${before_type}) ","? when (?<after> ${after_type})

  # Passives
  - name: assembly-syntax-pass-1
    label: DirectConnection
    priority: ${deprulepriority}
    example: "the ubiquitination of BEF is followed by the phosphorylation of AFT."
    pattern: |
      before:${before_type}
      after:${after_type} = <nsubjpass [lemma=/^(precipitate|follow)$/] agent

  - name: assembly-syntax-pass-2
    label: DirectConnection
    priority: ${deprulepriority}
    example: "the ubiquitination of AFT is preceded by the phosphorylation of BEF."
    pattern: |
      after:${after_type}
      before:${before_type} = <nsubjpass [lemma=/^(precede)$/] agent

  - name: assembly-syntax-pass-3
    label: DirectConnection
    priority: ${deprulepriority}
    example: "the ubiquitination of BEF is required for the phosphorylation of AFT.  The binding of p85 and Gab1 is required for Gab1 mediated activation of PI-3 kinase."
    pattern: |
      before:${before_type}
      # describes a precondition
      # ... is required for AFT
      after:${after_type} = <nsubjpass [lemma=require] prep_for

  - name: assembly-syntax-dependent-on
    label: DirectConnection
    priority: ${deprulepriority}
    example: "Together these data demonstrate that E2-induced SRC-3 phosphorylation is dependent on a direct interaction between SRC-3 and ERα and can occur outside of the nucleus."
    pattern: |
      after:${after_type}
      before:${before_type} = <nsubj dependent prep_on

  - name: assembly-surface-dependent-on
    label: DirectConnection
    priority: ${surfacerulepriority}
    example: "Together these data demonstrate that E2-induced SRC-3 phosphorylation is dependent on a direct interaction between SRC-3 and ERα and can occur outside of the nucleus."
    type: token
    pattern: |
      @after:${after_type} [lemma=be] dependent on [tag=/^(DT|CD|JJ)/]* @before:${before_type}

  ############################
  # Surface rules
  ############################

  # finds a direct connection
  - name: assembly-surface-1
    example: "AFT is ubiquitination immediately follows the phosphorylation of BEF. AFT is ubiquitinated immediately following the phosphorylation of BEF.  BEF ubiquitination is immediately followed by the phosphorylation of AFT."
    label: DirectConnection
    type: token
    priority: ${surfacerulepriority}
    pattern: |
      # "BEF precedes AFT" pattern
      @before:${before_type} [lemma=be]? [lemma=/^immediate|direct$/] ${beforesurface} [tag=IN]? [tag=DT]? @after:${after_type}
      |
      # "AFT follows BEF" pattern
      @before:${before_type} [lemma=be]? [lemma=/^immediate|direct$/] ${aftersurface} [tag=IN]? [tag=DT]? @after:${after_type}

  # finds a direct connection
  - name: assembly-surface-2
    example: "AFT is ubiquitinated following the phosphorylation of BEF.  BEF is ubiquitinated prior to the phosphorylation of AFT."
    label: ${mylabel}
    type: token
    priority: ${surfacerulepriority}
    pattern: |
      # "BEF precedes AFT" pattern
      @before:${before_type} [lemma=be]? ${aftersurface} [tag=IN]? [tag=DT]? @after:${after_type}
      |
      # "AFT follows BEF" pattern
      @before:${before_type} [lemma=be]? ${beforesurface} [tag=IN]? [tag=DT]? @after:${after_type}

  - name: assembly-surface-3
    example: "AFT is ubiquitinated in response to the phosphorylation of BEF."
    label: ${mylabel}
    type: token
    priority: ${surfacerulepriority}
    pattern: |
     @after:${after_type} in response to []{,2} @before:${before_type}

  - name: assembly-surface-4
    example: "BEF ubiquitination has downstream effects on the phosphorylation of AFT."
    label: ${mylabel}
    type: token
    priority: ${surfacerulepriority}
    pattern: |
     # NOTE: event "A has no effect on B" implies A before B
     @before:${before_type} [lemma=have] []{,2} [lemma=effect] on []{,2} @after:${after_type}

  - name: assembly-surface-5
    example: "AFT ubiquitination is a result of BEF phosphorylation."
    label: ${mylabel}
    type: token
    priority: ${surfacerulepriority}
    pattern: |
     @after:${after_type} [lemma=be] result of []{,2} @before:${before_type}

  - name: assembly-surface-6
    example: "BEF is ubiquitinated, resulting in the phosphorylation of AFT."
    label: ${mylabel}
    type: token
    priority: ${surfacerulepriority}
    pattern: |
     @before:${before_type} []{,2} [lemma=result] in []{,2} @after:${after_type}

  - name: assembly-surface-7
    example: "BEF is ubiquitinated, thereby increasing the phosphorylation of AFT."
    label: ${mylabel}
    type: token
    priority: ${surfacerulepriority}
    pattern: |
     @before:${before_type} []{,2} [lemma=thereby] []{,3} @after:${after_type}
